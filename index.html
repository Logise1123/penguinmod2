
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta property="theme-color" content="#51D3F4">
  <link rel="icon" href="https://penguinmod.com/favicon.ico" />
  <title>PenguinMod - Home</title>
  <meta name="title" content="PenguinMod - Home">
  <meta name="description" content="Featured projects and community .pmp uploads for PenguinMod GitHub">
  <style>
    :root {
      --bg-dark: #181c21;
      --bg-dark2: #23232e;
      --bg-box: #242534;
      --pm-blue: #51D3F4;
      --pm-yellow: #FFE74C;
      --pm-pink: #FF66C7;
      --pm-green: #45ff89;
      --pm-text: #fff;
      --pm-text2: #b0bada;
      --section-title: #ffec3b;
      --sep-border: #292b3d;
      --shadow-card: 0 0 18px #37ecf390, 0 0px 3px #ffe74c71;
      --card-radius: 14px;
      --btn-bg: #272844;
      --btn-yellow: #ffe74c;
      --btn-pink: #ff75d9;
      --btn-blue: #51d3f4;
      --header-gradient: linear-gradient(90deg,#51d3f4 0%,#51d3f4 100%);
    }
    body {margin: 0;font-family: "Segoe UI", "Montserrat", "Arial", sans-serif;background: var(--bg-dark);color: var(--pm-text);min-height: 100vh;}
    header {background: var(--header-gradient);color: #222;font-size: 2.2em;padding: 1.1em 0 0.6em 0;text-align: center;font-weight: 700;text-shadow: 1px 2px 26px #0de4ff38;letter-spacing: 1px;border-bottom: 5px solid var(--pm-blue);position: relative;}
    .subtitle {display: block;color: #265c71;font-size: 1.0em;font-weight: 600;text-shadow: none;letter-spacing: .02em;margin-top: 3px;margin-bottom: 3px;text-align: center;}
    nav {background: var(--bg-dark2);border-bottom: 2px solid var(--sep-border);display: flex;align-items: center;padding: 0.4em 0 0.3em 0;justify-content: center;gap: 12px;margin-bottom: 8px;}
    nav button {background: var(--btn-bg);color: var(--pm-blue);border: none;border-radius: 14px;margin: 0 4px;padding: 0.75em 2.2em;font-size: 1.09em;font-weight: 600;cursor: pointer;letter-spacing: 0.07em;box-shadow: 0 0px 12px #1117, 0 1.5px 8px #51d3f422;transition: background 0.15s, color 0.17s;}
    nav button.active {background: var(--pm-yellow);color: #181c21;box-shadow: 0 2px 18px #ffe74c72, 0 0px 6px #ffe74c94;}
    main {width: 100vw;max-width: 1260px;margin: 0 auto;padding: 0 0 1em 0;min-height: 500px;}
    .guidelines-warning-box {padding: 8px;border-radius: 4px;border: 1px solid rgb(255, 153, 0);background: rgb(255, 217, 0, 0.5);color: #181c21;margin: 1.6em auto 2em auto;width: 94vw;max-width: 820px;font-weight: 500;font-size: 1.02em;text-align: center;}
    .section-projects {margin-top: 22px;width: 98vw;max-width: 1120px;margin-left: auto;margin-right: auto;}
    .section-title {color: var(--section-title);font-size: 1.41em;font-weight: 700;letter-spacing: .04em;margin-left: 18px;text-shadow: 0 2px 16px #ffe74c19;display: flex;align-items: center;gap: 13px;}
    .carousel-section {margin-bottom: 38px;}
    .carousel-header {display: flex;justify-content: space-between;align-items: baseline;margin: 0 0 2 0;}
    .carousel-title {color: var(--pm-blue);font-size: 1.09em;font-weight: 700;margin-left: 15px;letter-spacing: 0.07em;text-shadow: 0 2px 26px #6efffb31;}
    .carousel-link {color: var(--pm-yellow);text-decoration: none;margin-right: 15px;font-size: .96em;font-weight: 500;transition: color 0.16s;}
    .carousel-link:hover { color: var(--pm-pink);}
    .carousel-scroll {overflow-x: auto;display: flex;align-items: stretch;gap: 18px;padding-bottom: 0.7em;scrollbar-color: var(--pm-blue) #232332;scrollbar-width: thin;}
    .carousel-scroll::-webkit-scrollbar { height: 8px; }
    .carousel-scroll::-webkit-scrollbar-thumb { background: var(--pm-yellow); border-radius: 7px; }
    .carousel-scroll::-webkit-scrollbar-track { background: var(--bg-dark2); }
    .card-project {background: var(--bg-box);border-radius: var(--card-radius);box-shadow: var(--shadow-card);min-width: 170px;max-width: 210px;width: 190px;padding-bottom: 4px;margin: 6px 0 12px 0;display: flex;flex-direction: column;align-items: center;overflow: hidden;cursor: pointer;position: relative;border: 2px solid transparent;transition: box-shadow 0.17s, border 0.2s;}
    .card-project.latest { border-color: var(--pm-blue);}
    .card-project.featured { border-color: var(--pm-pink);}
    .card-project.games { border-color: var(--pm-green);}
    .card-project:hover {box-shadow: 0 4px 22px #ffe74c77, 0 2px 18px #51d3f470;border-color: var(--pm-yellow);z-index: 2;}
    .card-thumb {width: 98%;aspect-ratio: 1/1;min-height: 109px;max-height: 148px;object-fit: cover;margin-top: 6px;background: #2e3549;border-radius: 8px;box-shadow: 0 0 8px #37ecf316;border: 2.8px solid #51d3f4;image-rendering: pixelated;display:block;}
    .card-title {font-weight: 700;font-size: 1em;color: var(--pm-yellow);padding: 7px 12px 3px 12px;width: 95%;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;text-align: center;letter-spacing: .01em;font-family: "Segoe UI", "Montserrat", Arial, sans-serif;text-shadow: 0 2px 9px #ffe74c40;}
    .card-meta {text-align: center;font-size: 0.93em;color: var(--pm-blue);font-weight: 500;opacity: 0.82;}
    .card-author {color: var(--pm-pink);font-weight: 600;font-size: 0.98em;margin-right: 3px;}
    .card-desc {font-size: 0.94em;padding: 0 11px 0 11px;color: var(--pm-text2);margin-bottom: 7px;min-height: 2.1em;line-height: 1.22em;text-align: center;}
    .download-btn {background: var(--pm-blue);color: #19191e;border: none;border-radius: 12px;font-weight: bold;font-size: 1em;padding: 0.6em 1.2em;margin-bottom: 7px;transition: background 0.12s, color 0.13s;box-shadow: 0 1px 12px #51d3f475;cursor: pointer;font-family: 'Segoe UI',Arial,sans-serif;width: 88%;}
    .download-btn:hover { background: var(--pm-yellow); color: #222;}
    .popup-bg {display: none;position: fixed;top: 0; left: 0; right: 0; bottom: 0;background: rgba(20,20,30,0.93);z-index: 120;align-items: center;justify-content: center;}
    .popup {background: #232842;color: #fafafa;max-width: 410px;width: 95vw;border-radius: 15px;box-shadow: 0 4px 70px #1ec9ff33, 0 2px 18px #ffe74c55;padding: 2em;text-align: center;position: relative;border: 3px solid var(--pm-blue);margin: 1.2em;}
    .popup img {width: 58%;max-height: 160px;object-fit: contain;margin-bottom: 1em;border-radius: 13px;box-shadow: 0 1px 18px #1ec9ff33;background:#28314e;image-rendering: pixelated;}
    .popup button.close {position: absolute;top: 8px;right: 8px;background: var(--pm-yellow);border: none;border-radius: 50%;width: 32px;height: 32px;font-size: 1.2em;color: #232332;cursor: pointer;font-weight: bold;transition: background 0.16s;box-shadow: 0 0 8px #ffe80022;}
    .popup button.close:hover { background: var(--pm-pink); color: #fff;}
    .popup .file-title {margin-top: 0.13em;margin-bottom: .18em;color: var(--pm-yellow);font-size: 1.16em;font-weight: bold;text-shadow: 0 2px 8px #ffe74c30;}
    .popup .file-meta {margin-bottom:0.7em;}
    .popup .file-desc {margin-bottom:1.11em;}
    #uploadSec, #homeSec, #accountSec, #loginSec {display: none;background: var(--bg-box);border-radius: 21px;min-height: 200px;box-shadow: 0 2px 30px #08131e99;margin: 2.2em auto 2em auto;padding: 2.2em 1.1em 2em 1.1em;max-width: 950px;}
    label {font-weight: 600;color: var(--pm-blue);margin-bottom: .2em;display: block;font-size:1em;}
    input[type="text"], input[type="password"], textarea {width: 97.5%;padding: 0.65em 8px;border: 1.7px solid var(--pm-yellow);border-radius: 9px;font-size: 1em;outline: none;margin-bottom: .25em;background: #222637;color: var(--pm-yellow);font-weight: 500;font-family: inherit;}
    textarea {min-height:40px;resize:vertical;}
    input[type="file"]{margin-top:.12em;font-family:inherit;color:#f9f9f9;}
    ::file-selector-button {background: var(--pm-blue);color: #222;border: none;padding: 6px 19px;border-radius: 8px;font-family: inherit;font-weight: bold;cursor: pointer;transition: background 0.13s;}
    ::file-selector-button:hover{background:var(--pm-pink);}
    .form-actions{text-align:center;}
    .form-actions button {padding: 0.78em 2.3em;font-size: 1.07em;background: var(--pm-blue);color:#19191e;border: none;border-radius: 9px;font-weight: bold;cursor: pointer;transition: background .16s, color 0.13s;font-family: inherit;margin-top: .32em;}
    .form-actions button:hover {background:var(--pm-yellow);color:#211;}
    .msg {margin:1.19em 0 0 0;color:var(--pm-yellow);font-weight:700;font-size:1.08em;text-align:center;}
    #tokeninfo{background:#1f293c;color:var(--pm-yellow);padding:.8em;border-radius:7px;font-size:1em;margin-bottom:1em;border:1.8px solid #3d404d;}
    .error-message{color:var(--pm-pink);background:#2e1d36;padding:.5em .85em;border-radius:6px;margin:.6em 0 1em 0;text-align:center;}
    .account-area {text-align:center;margin:1.2em 0 .5em 0}
    .account-area b {color:var(--pm-yellow);}
    .account-btns {display:inline-block;margin:0.6em 0;}
    .account-btns button {margin: 0 .3em;padding: 0.6em 1.4em;background: var(--pm-blue);color:#19191e;font-weight:600;border-radius: 6px;font-size:1em;}
    .account-btns button:hover { background: var(--pm-yellow);}
    @media (max-width: 900px){
      main{max-width:100vw;padding-left:0;padding-right:0;}
      .section-projects{max-width:100vw;}
      .carousel-scroll{gap:12px;}
      #uploadSec, #homeSec, #accountSec, #loginSec{margin:14px 0;padding: 0.5em 0.2em 1.4em 0.2em;}
      .section-title{font-size:1em;}
    }
  </style>
</head>
<body>
  <header>
    <img src="https://penguinmod.com/favicon.ico" alt="PenguinMod" style="height:1.1em;vertical-align:middle;margin-right:0.4em;">
    PenguinMod
    <span class="subtitle">Second server for when the first falls down (FAN MADE)</span>
  </header>
  <nav>
    <button id="btnHome" class="active">Home</button>
    <button id="btnUpload">Upload Project</button>
    <button id="btnAccount">Account</button>
  </nav>
  <div class="guidelines-warning-box">
    Please only upload projects, thumbnails, and information that comply with the PenguinMod community guidelines.<br>
    <b>Do not upload offensive, NSFW, or spam content.</b>
  </div>
  <main>
    <section id="homeSec">
      <div id="accountBar" class="account-area"></div>
      <div class="section-projects">
        <div class="carousel-section" id="latestSection">
          <div class="carousel-header">
            <div class="section-title">🌟 Latest featured projects</div>
            <a class="carousel-link" href="#" onclick="return false;">See more</a>
          </div>
          <div class="carousel-scroll" id="latestCarousel"></div>
        </div>
        <div class="carousel-section" id="featuredSection">
          <div class="carousel-header">
            <div class="section-title" style="color:#ff66c7">💖 Projects people want Featured</div>
            <a class="carousel-link" href="#" onclick="return false;">See more</a>
          </div>
          <div class="carousel-scroll" id="featuredCarousel"></div>
        </div>
        <div class="carousel-section" id="gamesSection">
          <div class="carousel-header">
            <div class="section-title" style="color:#45ff89">🎮 Projects marked as #games</div>
            <a class="carousel-link" href="#" onclick="return false;">See more</a>
          </div>
          <div class="carousel-scroll" id="gamesCarousel"></div>
        </div>
      </div>
      <div id="noFilesMsg" style="margin-top:1em;text-align:center;color:var(--pm-text2);font-size:1.07em;"></div>
      <div id="errHome" class="error-message" style="display:none"></div>
    </section>
    <section id="uploadSec">
      <div class="account-area" id="mustLoginMsg"></div>
      <h2 class="section-title" style="font-size:1.13em;margin-bottom:18px;">⬆️ Upload your .pmp file (uses GitHub)</h2>
      <div id="tokeninfo">
        All uploads are processed and stored via PenguinMod's cloud worker server.<br>
        <small>Do not upload illegal or inappropriate content.</small>
      </div>
      <form id="uploadForm" autocomplete="off">
        <div class="form-row">
          <label for="pmpFile">.pmp file</label>
          <input type="file" id="pmpFile" accept=".pmp" required>
        </div>
        <div class="form-row">
          <label for="miniatura">Thumbnail (.jpg, .png or .gif)</label>
          <input type="file" id="miniatura" accept="image/png,image/jpeg,image/gif" required>
        </div>
        <div class="form-row">
          <label for="titulo">Title</label>
          <input type="text" id="titulo" maxlength="48" required>
        </div>
        <div class="form-row">
          <label for="autor">Author</label>
          <input type="text" id="autor" maxlength="32" required disabled placeholder="Set by account login.">
        </div>
        <div class="form-row">
          <label for="desc">Description</label>
          <textarea id="desc" maxlength="240" required></textarea>
        </div>
        <div class="form-row">
          <label for="tags">Tags <small>(comma separated, e.g: game,featured)</small></label>
          <input type="text" id="tags" maxlength="128">
        </div>
        <div class="form-actions"><button type="submit">Upload project</button></div>
        <div class="msg" id="uploadMsg"></div>
      </form>
    </section>
    <section id="accountSec">
      <h2 class="section-title">Account</h2>
      <div class="account-btns">
        <button onclick="showLogin()">Login</button>
        <button onclick="showRegister()">Register</button>
        <button onclick="logout()">Logout</button>
      </div>
      <div id="loggedStatus"></div>
    </section>
    <section id="loginSec">
      <h3 class="section-title">Sign In</h3>
      <form id="loginForm">
        <div class="form-row">
          <label for="loginName">Username</label>
          <input type="text" id="loginName" maxlength="32" required autocomplete="username">
        </div>
        <div class="form-row">
          <label for="loginPw">Password</label>
          <input type="password" id="loginPw" required autocomplete="current-password">
        </div>
        <div class="form-actions"><button type="submit">Login</button></div>
        <div class="msg" id="loginMsg"></div>
      </form>
    </section>
    <section id="registerSec" style="display:none;background:var(--bg-box);border-radius:21px;box-shadow:0 2px 30px #08131e99;margin:2.2em auto 2em auto;max-width:950px;padding:2.2em 1.1em 2em 1.1em;">
      <h3 class="section-title">Register Account</h3>
      <form id="registerForm">
        <div class="form-row">
          <label for="regName">Username</label>
          <input type="text" id="regName" maxlength="32" required>
        </div>
        <div class="form-row">
          <label for="regPw">Password</label>
          <input type="password" id="regPw" required>
        </div>
        <div class="form-actions"><button type="submit">Register</button></div>
        <div class="msg" id="registerMsg"></div>
      </form>
    </section>
  </main>
  <div class="popup-bg" id="popupBg">
    <div class="popup" id="popupCard">
      <button class="close" onclick="closePopup()">×</button>
      <img id="popupThumb" src="" alt="Thumbnail">
      <div class="file-title" id="popupTitle"></div>
      <div class="file-meta">
        <span id="popupAuthor"></span> • <span id="popupTime"></span>
      </div>
      <div class="file-desc" id="popupDesc"></div>
      <button class="download-btn" id="popupDownloadBtn">Download .pmp</button>
    </div>
  </div>
  <footer style="background:var(--bg-dark2);color:var(--pm-text2);text-align:center;padding:2em 0 1em 0;margin-top:3em;font-size:1em;">
    PenguinMod is not affiliated with Scratch, TurboWarp, the Scratch Team, or the Scratch Foundation.
    <div style="display:flex;gap:18px;justify-content:center;margin-top:1.3em;flex-wrap:wrap;">
      <div><b>Website</b><br>
        <a href="https://studio.penguinmod.com/editor.html" class="carousel-link" style="font-size:.99em;">Editor</a><br>
        <a href="https://studio.penguinmod.com/credits.html" class="carousel-link" style="font-size:.99em;">Credits</a><br>
        <a href="https://github.com/PenguinMod/" class="carousel-link" style="font-size:.99em;">Source</a>
      </div>
      <div><b>Community</b><br>
        <a href="https://github.com/PenguinMod/PenguinMod-Home/issues" class="carousel-link" style="font-size:.99em;">Report an issue</a><br>
        <a href="https://wiki.penguinmod.com/wiki/Main_Page" class="carousel-link" style="font-size:.99em;">Community Wiki</a>
      </div>
      <div><b>Donate</b><br>
        <a href="/donate" class="carousel-link" style="font-size:.99em;">PenguinMod</a><br>
        <a href="https://github.com/sponsors/GarboMuffin" class="carousel-link" style="font-size:.99em;">TurboWarp</a>
      </div>
    </div>
  </footer>
  <script>
    const WORKER_API = "https://royal-term-e73b.arielcapdevilagarcia.workers.dev/";
    const METAFILE = "proyectos.json";
    const ACCOUNTS_JSON = "accounts.json";
    let account = null;

    function showSection(sec) {
      document.getElementById("homeSec").style.display = sec==="home" ? "block" : "none";
      document.getElementById("uploadSec").style.display = sec==="upload" ? "block" : "none";
      document.getElementById("accountSec").style.display = sec==="account" ? "block" : "none";
      document.getElementById("loginSec").style.display = "none";
      document.getElementById("registerSec").style.display = "none";
      document.getElementById("btnHome").classList.toggle("active", sec==="home");
      document.getElementById("btnUpload").classList.toggle("active", sec==="upload");
      document.getElementById("btnAccount").classList.toggle("active", sec==="account");
      document.getElementById("errHome").style.display = "none";
      if(sec==="home") { updateAccountBar(); listProjects(); }
      if(sec==="upload") { showUploadAuth(); document.getElementById('uploadMsg').innerText = ""; }
      if(sec==="account") updateAccountStatus();
    }

    document.getElementById("btnHome").onclick = ()=>showSection("home");
    document.getElementById("btnUpload").onclick = ()=>showSection("upload");
    document.getElementById("btnAccount").onclick = ()=>showSection("account");

    function fileToBase64(file, cb) {
      const r = new FileReader();
      r.onload = ()=>cb(r.result);
      r.readAsDataURL(file);
    }

    function saveAccountLocal(acc) {
      account = acc;
      localStorage.setItem("penguinmod_account", JSON.stringify(account || {}));
    }
    function getAccountLocal() {
      try {
        account = JSON.parse(localStorage.getItem("penguinmod_account")||"{}");
        return account && account.username ? account : null;
      } catch(e) { return null; }
    }
    function updateAccountBar() {
      const bar = document.getElementById("accountBar");
      if(getAccountLocal()) {
        bar.innerHTML = 'Signed in as <b>'+account.username+'</b> <button onclick="logout()">Logout</button>';
      } else {
        bar.innerHTML = 'Not signed in. <button onclick="showLogin()">Login</button> <button onclick="showRegister()">Register</button>';
      }
    }
    function showLogin() {
      hideAllSections();
      document.getElementById("loginSec").style.display = "block";
      document.getElementById("loginMsg").innerText = "";
    }
    function showRegister() {
      hideAllSections();
      document.getElementById("registerSec").style.display = "block";
      document.getElementById("registerMsg").innerText = "";
    }
    function hideAllSections() {
      document.getElementById("homeSec").style.display = "none";
      document.getElementById("uploadSec").style.display = "none";
      document.getElementById("accountSec").style.display = "none";
      document.getElementById("loginSec").style.display = "none";
      document.getElementById("registerSec").style.display = "none";
    }
    function updateAccountStatus() {
      const s = document.getElementById("loggedStatus");
      let acc = getAccountLocal();
      if(acc && acc.username) {
        s.innerHTML = `You are signed in as <b>${acc.username}</b>.`;
      } else {
        s.innerHTML = `Not signed in.`;
      }
    }
    function logout() {
      saveAccountLocal(null);
      updateAccountBar();
      showSection('home');
    }

    // ==== ACCOUNTS VIA WORKER (soporta base64-encoded JSON GitHub) ====
    async function workerDownloadAccounts() {
      try {
        let r = await fetch(WORKER_API + "?file="+encodeURIComponent(ACCOUNTS_JSON));
        if (!r.ok) return [];
        const obj = await r.json();
        // Soporta respuesta array puro o GitHub {content...}
        if (Array.isArray(obj)) return obj;
        if (typeof obj === 'object' && obj.content && obj.encoding === 'base64') {
          const txt = atob(obj.content.replace(/\n/g, ''));
          try {
            const arr = JSON.parse(txt);
            if (Array.isArray(arr)) return arr;
            return [];
          } catch(e) { return []; }
        }
        return [];
      } catch(e) { return []; }
    }
    // Register form
    document.getElementById("registerForm").onsubmit = async function(ev) {
      ev.preventDefault();
      const username = document.getElementById("regName").value.trim();
      const pw = document.getElementById("regPw").value;
      const msg = document.getElementById("registerMsg");
      msg.innerText = "Registering...";
      if(!username || !pw) return msg.innerText = "Fill all fields";
      let result;
      try {
        let resp = await fetch(WORKER_API + "register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, pass: pw })
        });
        result = await resp.json();
        if(resp.ok) {
          msg.innerText = "Account created. You can now login.";
        } else {
          msg.innerText = (result.error || JSON.stringify(result));
        }
      } catch(e) {
        msg.innerText = "Error: " + (e.message||e);
      }
    };
    // Login form
    document.getElementById("loginForm").onsubmit = async function(ev) {
      ev.preventDefault();
      const username = document.getElementById("loginName").value.trim();
      const pw = document.getElementById("loginPw").value;
      const msg = document.getElementById("loginMsg");
      msg.innerText = "Logging in...";
      let accounts = await workerDownloadAccounts();
      if(!Array.isArray(accounts)) accounts = [];
      const pwHash = await sha256hex(pw);
      const acc = accounts.find(x=>x.username === username && x.pass === pwHash);
      if(acc) {
        saveAccountLocal({username});
        msg.innerText = "Logged in!";
        showSection("home");
        updateAccountBar();
      } else {
        msg.innerText = "Login failed (wrong user/pass, or server down).";
      }
    };

    function showUploadAuth() {
      const acc = getAccountLocal();
      document.getElementById('mustLoginMsg').innerHTML =
        acc && acc.username
          ? "<b>Logged in as</b>: "+acc.username
          : "You must be logged in to upload a project.";
      document.getElementById('uploadForm').style.display = acc && acc.username ? "block" : "none";
      document.getElementById('autor').value = acc && acc.username ? acc.username : "";
    }

    // ========== PROJECTS (también tolerante a content base64) ==========
    async function workerDownloadProjects() {
      try {
        let r = await fetch(WORKER_API + "?file="+encodeURIComponent(METAFILE));
        if(!r.ok) return [];
        const obj = await r.json();
        if (Array.isArray(obj)) return obj;
        if (typeof obj === "object" && obj.content && obj.encoding==="base64") {
          const txt = atob(obj.content.replace(/\n/g,''));
          try {
            const arr = JSON.parse(txt);
            if(Array.isArray(arr)) return arr;
            return [];
          } catch (e) { return []; }
        }
        return [];
      } catch(e) { return []; }
    }
    async function listProjects() {
      let latest=[], featured=[], games=[];
      let arr=[];
      let msg = document.getElementById("noFilesMsg");
      let errMsg = document.getElementById("errHome");
      document.getElementById("latestCarousel").innerHTML = "";
      document.getElementById("featuredCarousel").innerHTML = "";
      document.getElementById("gamesCarousel").innerHTML = "";
      msg.innerHTML = "Loading...";
      try { arr = await workerDownloadProjects(); } catch(e) {
        msg.innerHTML = "No projects or could not connect.<br>"+e;
        errMsg.style.display = "block";
        errMsg.innerText = e;
        return;
      }
      if(!Array.isArray(arr)||arr.length===0) {
        msg.innerHTML = "No projects yet. Be the first to upload!";
        return;
      }
      msg.innerHTML = "";
      arr.forEach(function(proj){
        let tags = (typeof proj.tags==="string" ? proj.tags : Array.isArray(proj.tags)?proj.tags.join():"").toLowerCase();
        if(tags.includes("game")) games.push(proj);
        if(tags.includes("featured")) featured.push(proj);
        latest.push(proj);
      });
      renderCarousel(latest.slice(0,14), document.getElementById("latestCarousel"), "latest");
      renderCarousel(featured.slice(0,12), document.getElementById("featuredCarousel"), "featured");
      renderCarousel(games.slice(0,12), document.getElementById("gamesCarousel"), "games");
    }

    function renderCarousel(arr, cont, styleClass) {
      if(!arr.length) { cont.innerHTML = "<div style='color:#464f64;text-align:center;font-size:1em;padding:1em;'>No projects</div>"; return; }
      cont.innerHTML = "";
      arr.forEach(function(proj){
        const card = document.createElement("div");
        card.className = "card-project " + styleClass;
        card.onclick = ()=>showDownloadPopup(proj.id, arr);
        const img = document.createElement("img");
        img.className = "card-thumb";
        img.src = proj.thumb;
        img.alt = "Thumbnail";
        const titleDiv = document.createElement("div");
        titleDiv.className = "card-title";
        titleDiv.innerText = proj.title;
        const meta = document.createElement("div");
        meta.className = "card-meta";
        meta.innerHTML = `<span class="card-author">${proj.author ? proj.author : "?"}</span>
         • <span>${proj.time ? formatShortDate(proj.time) : ""}</span>`;
        const descDiv = document.createElement("div");
        descDiv.className = "card-desc";
        descDiv.innerText = proj.desc.length>62?proj.desc.slice(0,62)+"…":proj.desc;
        card.appendChild(img);
        card.appendChild(titleDiv);
        card.appendChild(meta);
        card.appendChild(descDiv);
        cont.appendChild(card);
      });
    }
    function formatShortDate(ts){
      if(!ts) return "";
      let d = new Date(ts);
      return d.toLocaleDateString([],{month:"short",day:"numeric"}) +
        " " + d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
    }

    // ========== SUBIDA DE PROYECTO (VIA WORKER) ==========
    document.getElementById("uploadForm").onsubmit = function(ev) {
      ev.preventDefault();
      const acc = getAccountLocal();
      if(!acc || !acc.username) {
        msg("You must be logged in.", false);
        return;
      }
      const inputFile = document.getElementById("pmpFile").files[0];
      const miniFile = document.getElementById("miniatura").files[0];
      const titulo = document.getElementById("titulo").value.trim();
      const autor = acc.username;
      const desc = document.getElementById("desc").value.trim();
      const tags = document.getElementById("tags").value.trim();
      msg("");
      if(!inputFile || !miniFile || !titulo || !desc ) {
        msg("Please fill in all required fields.");
        return;
      }
      msg("Uploading project, please wait…");
      fileToBase64(miniFile, function(miniData){
        fileToBase64(inputFile, function(pmpData){
          let proj = {
            id: "penguinmod-" + Date.now() + Math.random().toString(36).slice(2,8),
            title: titulo,
            desc: desc,
            thumb: miniData,
            pmpName: inputFile.name,
            author: autor,
            tags: tags,
            pmpFile: "",
            time: Date.now()
          };
          subirProyectoViaWorker(proj, pmpData.replace(/^data:.*?base64,/, ""), function(ok, error){
            msg(ok?"Uploaded! Updating list...":"Error: " + error, ok);
            if(ok) setTimeout(()=>showSection("home"), 1200);
          });
        });
      });
    };

    function msg(text, ok){
      const m=document.getElementById("uploadMsg");
      m.innerText = text || "";
      m.style.color = ok ? "#45ff89" : "#ffe74c";
    }
    async function subirProyectoViaWorker(proj, pmpB64, cb) {
      try{
        const pmp_path = "archivos/" + proj.id + ".pmp";
        let resPmp = await fetch(WORKER_API, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            path: pmp_path,
            message: "Subida " + proj.id + ".pmp por " + (proj.author||"?"),
            content_b64: pmpB64
          })
        });
        let outPmp = await resPmp.json();
        if(!resPmp.ok) return cb(false, (outPmp.message||outPmp.error||"Error subiendo .pmp"));

        proj.pmpFile = pmp_path;
        let lista = [];
        try{ lista = await workerDownloadProjects(); }catch{} 
        if(!Array.isArray(lista)) lista = [];
        lista = [proj, ...lista.filter(x=>x.id!==proj.id)];
        const metaBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(lista,null,1))));
        let putMeta = await fetch(WORKER_API, {
          method: "PUT",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            path: METAFILE,
            content_b64: metaBase64,
            message: "Actualiza proyectos"
          })
        });
        let outMeta = await putMeta.json();
        if(!putMeta.ok) return cb(false, (outMeta.message||outMeta.error||"Error actualizando lista de proyectos"));
        return cb(true,null);
      }catch(e){ cb(false, e.message||e); }
    }

    let currentProj = null;
    function showDownloadPopup(id, arr) {
      const p = (arr||[]).find(x=>x.id===id);
      if(!p) return;
      currentProj = p;
      document.getElementById("popupThumb").src = p.thumb;
      document.getElementById("popupTitle").innerText = p.title;
      document.getElementById("popupAuthor").innerText = p.author||"Anonymous";
      document.getElementById("popupTime").innerText = formatShortDate(p.time||Date.now());
      document.getElementById("popupDesc").innerText = p.desc;
      document.getElementById("popupBg").style.display = "flex";
    }
    document.getElementById("popupDownloadBtn").onclick = function(){
      if(!currentProj) return;
      downloadPMPviaWorker(currentProj.pmpFile, currentProj.pmpName||"penguinmod-project.pmp");
    }
    function closePopup() {
      document.getElementById("popupBg").style.display = "none";
      currentProj = null;
    }
    document.getElementById("popupBg").onclick = function(ev){
      if(ev.target===this) closePopup();
    }
    async function downloadPMPviaWorker(pmpFile, filename) {
      try {
        let resp = await fetch(WORKER_API + "?file=" + encodeURIComponent(pmpFile));
        if(resp.ok) {
          let blob = await resp.blob();
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          setTimeout(()=>a.remove(),99);
        }else{
          alert("Could not download the file.");
        }
      }catch(e){
        alert("Could not download the file.");
      }
    }
    async function sha256hex(str) {
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
    }
    showSection("home");
  </script>
</body>
</html>
